#!/usr/bin/env bash
set -euo pipefail

# Archive old GitHub repos interactively using gh + gum
# Usage: archive-old-repos [--dry-run] [--years N]

DRY_RUN=false
YEARS=8

while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --years)
      YEARS="$2"
      shift 2
      ;;
    *)
      echo "Usage: archive-old-repos [--dry-run] [--years N]"
      exit 1
      ;;
  esac
done

# Calculate cutoff date
CUTOFF_YEAR=$(($(date +%Y) - YEARS))
CUTOFF_DATE="${CUTOFF_YEAR}-01-01"

echo "Finding repos created before ${CUTOFF_DATE}..."

# Fetch repos: not archived, source only, created before cutoff
repos=$(gh repo list --source --no-archived --limit 200 --json name,createdAt,description,pushedAt \
  --jq '.[] | "\(.name)\t\(.createdAt[:10])\t\(.pushedAt[:10])\t\(.description // "-")"' \
  | while IFS=$'\t' read -r name created pushed desc; do
      if [[ "$created" < "$CUTOFF_DATE" ]]; then
        printf '%s\t%s\t%s\t%s\n' "$name" "$created" "$pushed" "$desc"
      fi
    done | sort -t$'\t' -k2)

if [[ -z "$repos" ]]; then
  echo "No repos found older than ${YEARS} years."
  exit 0
fi

count=$(echo "$repos" | wc -l | tr -d ' ')
echo "Found ${count} repos older than ${YEARS} years."
echo ""

# Interactive multi-select with gum
echo "Select repos to archive (tab to multi-select, enter to confirm):"
echo ""

selected=$(echo "$repos" | gum filter --no-limit \
  --header "NAME                    CREATED     LAST PUSH   DESCRIPTION" \
  --placeholder "Type to filter...")

if [[ -z "$selected" ]]; then
  echo "No repos selected."
  exit 0
fi

echo ""
echo "Selected repos:"
echo "$selected"
echo ""

if $DRY_RUN; then
  echo "[DRY RUN] Would archive the following repos:"
  echo "$selected" | while IFS=$'\t' read -r name created pushed desc; do
    echo "  - $name (created: $created)"
  done
  exit 0
fi

# Confirm and archive each
echo "$selected" | while IFS=$'\t' read -r name created pushed desc; do
  echo ""
  echo "ðŸ“¦ $name"
  echo "   Created: $created | Last push: $pushed"
  echo "   $desc"

  if gum confirm "Archive this repo?"; then
    gh repo archive "$name" --yes
    echo "   âœ“ Archived"
  else
    echo "   âœ— Skipped"
  fi
done

echo ""
echo "Done!"
